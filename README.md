# CounterEval: GNN-Based Predictive Modeling and Performance Evaluation for Soccer Counterattacks Using Tracking Data

TODO: Put a countereval .gif here.

## Description

Counterattacking is an effective strategy for scoring in modern football, championed by renowned coaches like José Mourinho, Diego Simeone, and Antonio conte. A successful counterattack is often executed by key players, making it valuable to develop metrics that evaluate individual contributions to the play. The analysis of soccer player movements and team tactics requires sophisticated computational approaches that can capture both individual dynamics and collective behavior. This study introduces **CounterEval**, a deep learning framework for evaluating player performance in counterattacks using tracking data from 632 games across MLS (2022), NWSL (2022), and international women’s soccer (2020 to 2022). The dataset includes detailed information on player and ball locations, velocity, and acceleration, and was refined through our quality improvements, such as correcting mislabeled counterattacks and filling missing player IDs. The core of the framework comprises two neural network models: a movement model, a variational autoencoder model fitting the distribution of a player’s next location given the spatial positions of all players, and a graph-based counterattacking success model, which estimates the probability of a successful counterattack given the current game context. By combining the two models, we develop a real-time evaluation metric that quantifies player performance during counterattacks. The framework is robust and scalable, with potential for further enhancement through higher-quality data and model fine-tuning.


## Reproduce our work

### Virtual Environment

```
conda env create -f environment.yml
conda activate sds625_soccer
```

### Run All Results

You can get all results of this project by running one of the two following commands.

```
Rscript scripts/Main.R # Option 1
# bash scripts/Main.sh # Option 2
```

### Data

#### Raw Datasets

The raw tracking dataset, sourced from [ussf\_ssac\_23\_soccer\_gnn](https://github.com/USSoccerFederation/ussf_ssac_23_soccer_gnn), contains player and ball tracking data for 632 games. Each frame of data is represented as a graph with **nodes** (players and the ball) and **edges** (spatial and temporal relationships). However, the raw dataset contains significant noise:
- Mislabeled counterattack outcomes.
- Unrealistic player and ball movements.
- Incorrect attacking team flags.

The Graph configuration is depicted by the graph below:

![Graph Configuration](img/graph.png)

(source: [ussf_ssac_23_soccer_gnn](https://github.com/USSoccerFederation/ussf_ssac_23_soccer_gnn))

To download all raw datasets for our project, run the following command.

```
bash scripts/get_raw_dataset.sh
```

#### Data Cleaning
1. **Error Identification:**
   - Visualize counterattacks using an interactive Streamlit app for manual inspection.
2. **Outcome and Flag Correction:**
   - Correct mislabeled counterattack outcomes and attacking team flags.
3. **Movement Anomalies:**
   - Identify and remove unrealistic player or ball movements (e.g., stationary ball for extended periods).
4. **Graph Representation:**
   - Transform the data into a **fully connected homogeneous graph**:
     - Nodes represent players and the ball.
     - Edges represent all pairwise relationships to facilitate GNN attention mechanisms.
   - **Edge features** are excluded as they are derived from node features and provide no additional information.

### Visualization

We also provide a streamlit app to visualize the counterattack process to facilitate our EDA. 

```
streamlit run scripts/visualize_helper.py
```
# Methodology

Please refer to our report for more details about our CounterEval framework.

The **CounterEval** framework evaluates player contributions during soccer counterattacks using a combination of movement prediction and tactical analysis, implemented through Graph Neural Networks (GNNs). This section provides a comprehensive breakdown of the methodology.

## 1. Player Movement Prediction with Transformer-Enhanced Variational Autoencoder (VAE)

To model player movements under counterattack scenarios, we employ a **Transformer-enhanced VAE**. The model predicts the next plausible locations of players given the current game context, serving as a baseline for counterfactual comparisons.

### Architecture:
1. **Input:**
   - Current player location $(x_t, y_t)$.
   - Contextual features $\theta(t-1)$ including positional and kinematic data of all players.
2. **Encoder:**
   - Maps the input to a latent space, outputting parameters $\mu$ and $\log \sigma$ for a 2D Gaussian distribution.
3. **Reparameterization:**
   - Samples latent variable $z \sim \mathcal{N}(\mu, \sigma^2)$.
4. **Decoder:**
   - Combines $z$ with contextual embeddings generated by a Transformer network to predict the player’s next location.
5. **Loss Function:**
   - The model is trained using the **reconstruction loss** (Mean Squared Error) combined with a **KL-divergence loss**.

### Output:
- Predicted player locations that serve as a proxy for "average" player movements under similar conditions.

## 2. Tactical Analysis with Graph Attention Networks (GAT)

To evaluate the success probability of a counterattack, we develop a **GAT-based tactical analysis model** that processes tracking data as a fully connected graph.

### Graph Representation:
- **Nodes:** Represent players and the ball.
- **Node Features:**
   - Position: $x, y$, velocity components: $v_x, v_y$, and derived metrics such as distance/angle to goal and ball.
   - Team flag (attacking or defending) and potential receiver indicator.
- **Edges:** Fully connected edges to enable global player interactions.

### Model Architecture:
1. **Input Graph:**
   - Fully connected graph $G = (V, E)$ with player nodes $v \in V$ and edges $e \in E$.
2. **Graph Attention Mechanism:**
   - Attention coefficients $\alpha_{ij}$ are computed to assign importance to neighboring nodes.
     
3. **Node Embeddings:**
   - Aggregated node embeddings are generated using the attention weights.
4. **Output Layer:**
   - A Multi-Layer Perceptron (MLP) maps the node embeddings to predict the probability of counterattack success.
5. **Loss Function:**
   - Binary Cross-Entropy (BCE) loss.

## 3. CounterEval Contribution Score

The **CounterEval Contribution Score** measures the impact of individual players on the success of a counterattack by comparing their actual movements to predicted baseline movements.

### Steps to Compute Contribution Scores:

1. **Baseline Movement Prediction:**
   - Use the VAE-based movement model to predict a plausible "average" location for a player.
2. **Counterfactual Analysis:**
   - Replace the actual position of a player with the predicted position from the movement model while holding all other players' positions fixed.
3. **Evaluate Success Probability:**
   - Compute the counterattack success probability for both:
     - The actual observed game state $P_{\text{actual}}$,
     - The counterfactual game state $P_{\text{counterfactual}}$.
4. **Score Calculation:**
   - The player’s contribution score is defined as the difference in success probabilities.
     
   - A **positive score** indicates that the player’s action increased the likelihood of success, while a **negative score** suggests the opposite.

5. **Event-Level Performance:**
   - Aggregate tick-level scores over the duration of a counterattack event $[t_1, t_2]$.
     

## 4. Model Training and Evaluation Pipeline

The overall pipeline ensures robust model development and evaluation:

- **Data Preparation:**
   - Clean and preprocess raw tracking data.
   - Represent each frame as a graph with node features.
- **Training:**
   - Train the VAE for movement prediction using MSE loss.
   - Train the GAT for counterattack success prediction using BCE loss.
- **Hyperparameter Tuning:**
   - Use grid search and Bayesian optimization to fine-tune hyperparameters.
- **Evaluation Metrics:**
   - **Movement Prediction:** Mean Squared Error (MSE), Root Mean Squared Error (RMSE).
   - **Counterattack Success Prediction:** Accuracy, F1-Score, and AUC.
   - **Performance Metrics:** Player-level contribution scores.


## Summary

The CounterEval framework combines player movement prediction with tactical analysis to evaluate contributions during counterattacks. By isolating individual player actions through counterfactual analysis, the framework provides a systematic, data-driven approach for performance evaluation. This methodology not only identifies key contributors but also offers actionable insights for coaching and player development.

## Acknowledgement 

## References
1. Sahasrabudhe, A., & Bekkers, J. (2023). _A Graph Neural Network Deep-Dive into Successful Counterattacks_. In 17th Annual MIT Sloan Sports Analytics Conference.
2. Veličković, P., Cucurull, G., Casanova, A., Romero, A., Liò, P., & Bengio, Y. (2017). Graph Attention Networks. arXiv, 1710.10903.


